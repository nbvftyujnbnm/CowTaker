<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cow Taker Online</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');
        body { font-family: 'Fredoka', sans-serif; background-color: #2D6E32; color: white; user-select: none; -webkit-user-select: none; }
        .card-shadow { box-shadow: 2px 2px 0px rgba(0,0,0,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .anim-pop { animation: pop 0.2s ease-out; }
        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        //  Ë®≠ÂÆö„Ç®„É™„Ç¢ („Åì„Åì„Å´Firebase Config„ÇíË≤º„Çã)
        // ==========================================
        const firebaseConfig = {
            // ‚òÖ„Åì„Åì„Å´Firebase„Ç≥„É≥„ÇΩ„Éº„É´„Åã„Çâ„Ç≥„Éî„Éº„Åó„ÅüConfig„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
            apiKey: "AIzaSyCEuMejvz9b7yl0eo4aNUv2tZuN37nLTBs",
    		authDomain: "cowtaker.firebaseapp.com",
  			projectId: "cowtaker",
    		storageBucket: "cowtaker.firebasestorage.app",
    		messagingSenderId: "54764846498",
    		appId: "1:54764846498:web:f6b8d36ad672c3d08586fb",
    		measurementId: "G-SRPT7362MW"
        };

        // FirebaseÂàùÊúüÂåñÔºàConfig„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØ„ÉÄ„Éü„Éº„ÅßÂãï‰Ωú„ÇíÈò≤„ÅêÔºâ
        let db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
            }
        } catch (e) {
            console.error("Firebase init error", e);
        }

        const { useState, useEffect, useRef } = React;

        // ==========================================
        //  „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ & „Éò„É´„Éë„Éº
        // ==========================================
        
        // ÁâõÔºàÂ§±ÁÇπÔºâ„ÅÆË®àÁÆó
        const getCows = (num) => {
            if (num === 55) return 7;
            if (num % 11 === 0) return 5;
            if (num % 10 === 0) return 3;
            if (num % 5 === 0) return 2;
            return 1;
        };

        // „Éá„ÉÉ„Ç≠ÁîüÊàê (1-104)
        const createDeck = () => {
            return Array.from({ length: 104 }, (_, i) => i + 1).sort(() => Math.random() - 0.5);
        };

        // ==========================================
        //  „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
        // ==========================================

        const Card = ({ num, size = "md", selected = false, onClick, revealed = true }) => {
            const cows = getCows(num);
            const bgColor = 
                cows === 7 ? "bg-red-500" : 
                cows === 5 ? "bg-blue-500" : 
                cows === 3 ? "bg-orange-500" : 
                cows === 2 ? "bg-sky-400" : "bg-slate-100";
            
            const textColor = cows === 1 ? "text-slate-800" : "text-white";
            
            const sizeClass = 
                size === "sm" ? "w-8 h-12 text-xs" : 
                size === "lg" ? "w-16 h-24 text-xl" : "w-12 h-16 text-sm";

            if (!revealed) {
                return (
                    <div className={`${sizeClass} rounded bg-indigo-800 border-2 border-white flex items-center justify-center card-shadow`}>
                        <div className="w-1/2 h-1/2 bg-indigo-600 rounded-full"></div>
                    </div>
                );
            }

            return (
                <div 
                    onClick={() => onClick && onClick(num)}
                    className={`${sizeClass} ${bgColor} ${textColor} rounded cursor-pointer flex flex-col items-center justify-between p-1 font-bold card-shadow transition-transform ${selected ? 'transform -translate-y-2 ring-2 ring-yellow-400' : ''}`}
                >
                    <span className="leading-none">{num}</span>
                    <div className="flex gap-0.5 flex-wrap justify-center w-full">
                        {Array.from({length: Math.min(cows, 5)}).map((_,i) => (
                            <div key={i} className={`rounded-full ${cows === 1 ? 'bg-slate-400' : 'bg-white/70'}`} style={{width: '4px', height: '4px'}}></div>
                        ))}
                         {cows > 5 && <span className="text-[8px] leading-none">+</span>}
                    </div>
                    <span className="leading-none transform rotate-180">{num}</span>
                </div>
            );
        };

        const Row = ({ cards, onSelect, isSelectable }) => {
            return (
                <div 
                    onClick={onSelect}
                    className={`flex items-center gap-1 bg-black/20 p-2 rounded-lg mb-2 overflow-x-auto no-scrollbar min-h-[4.5rem] transition-colors ${isSelectable ? 'ring-2 ring-yellow-400 bg-yellow-500/20 cursor-pointer' : ''}`}
                >
                    {cards.map((num) => (
                        <Card key={num} num={num} size="md" />
                    ))}
                    <div className="text-white/30 text-xs ml-auto pr-2">
                        {cards.reduce((acc, c) => acc + getCows(c), 0)}üêÆ
                    </div>
                </div>
            );
        };

        // ==========================================
        //  „É°„Ç§„É≥„Ç¢„Éó„É™
        // ==========================================

        const App = () => {
            const [view, setView] = useState("setup"); // setup, lobby, game
            const [playerName, setPlayerName] = useState("");
            const [roomId, setRoomId] = useState("");
            const [error, setError] = useState("");
            const [gameState, setGameState] = useState(null);
            const [myId, setMyId] = useState(null);
            
            // „Ç≤„Éº„É†ÂÜÖÁä∂ÊÖã
            const [selectedCard, setSelectedCard] = useState(null);

            // FirestoreË≥ºË™≠
            useEffect(() => {
                if (!db || !roomId || view === "setup") return;

                const unsubscribe = db.collection("rooms").doc(roomId).onSnapshot((doc) => {
                    if (doc.exists) {
                        setGameState(doc.data());
                    } else {
                        setError("ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                        setView("lobby");
                    }
                }, (err) => {
                    console.error(err);
                    setError("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
                });

                return () => unsubscribe();
            }, [roomId, view]);

            // ÈÉ®Â±ã‰ΩúÊàê
            const createRoom = async () => {
                if (!playerName) return setError("ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                if (!db) return setError("Firebase„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Ç≥„Éº„ÉâÂÜÖ„ÅÆConfig„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                
                const newRoomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                const playerId = Math.random().toString(36).substring(2, 9);
                
                const initialState = {
                    status: "waiting", // waiting, playing, round_end, game_end
                    players: [{ id: playerId, name: playerName, score: 0, hand: [], selected: null }],
                    hostId: playerId,
                    rows: [[], [], [], []],
                    deck: [],
                    turnCount: 0,
                    phase: "selection", // selection, resolution, row_selection
                    pendingCard: null, // Ë°åÈÅ∏ÊäûÂæÖ„Å°„ÅÆ„Ç´„Éº„ÉâÊÉÖÂ†±
                    pendingPlayerId: null
                };

                await db.collection("rooms").doc(newRoomId).set(initialState);
                setMyId(playerId);
                setRoomId(newRoomId);
                setView("lobby");
            };

            // ÈÉ®Â±ãÂèÇÂä†
            const joinRoom = async () => {
                if (!playerName || !roomId) return setError("ÂêçÂâç„Å®ÈÉ®Â±ãID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                if (!db) return setError("Firebase ConfigÊú™Ë®≠ÂÆö");

                const docRef = db.collection("rooms").doc(roomId);
                const doc = await docRef.get();
                
                if (!doc.exists) return setError("ÈÉ®Â±ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì");
                const data = doc.data();
                if (data.status !== "waiting") return setError("„Åô„Åß„Å´„Ç≤„Éº„É†„ÅåÂßã„Åæ„Å£„Å¶„ÅÑ„Åæ„Åô");

                const playerId = Math.random().toString(36).substring(2, 9);
                const newPlayers = [...data.players, { id: playerId, name: playerName, score: 0, hand: [], selected: null }];
                
                await docRef.update({ players: newPlayers });
                setMyId(playerId);
                setView("lobby");
            };

            // „Ç≤„Éº„É†ÈñãÂßã („Éõ„Çπ„Éà„ÅÆ„Åø)
            const startGame = async () => {
                const deck = createDeck();
                const players = [...gameState.players];
                const rows = [[], [], [], []];

                // Âàó„Å´1Êûö„Åö„Å§
                for(let i=0; i<4; i++) rows[i].push(deck.pop());
                rows.sort((a,b) => a[0] - b[0]); // ÂàùÊúüÂàó„ÅØÊòáÈ†Ü„Åò„ÇÉ„Å™„Åè„Å¶„ÇÇ„ÅÑ„ÅÑ„Åå„ÄÅË¶ã„ÇÑ„Åô„Åè„Åô„Çã„Åü„ÇÅ

                // „Éó„É¨„Ç§„É§„Éº„Å´10Êûö„Åö„Å§
                players.forEach(p => {
                    p.hand = [];
                    for(let i=0; i<10; i++) p.hand.push(deck.pop());
                    p.hand.sort((a,b) => a-b);
                    p.selected = null;
                });

                await db.collection("rooms").doc(roomId).update({
                    status: "playing",
                    phase: "selection",
                    deck,
                    rows,
                    players,
                    turnCount: 1
                });
            };

            // „Ç´„Éº„ÉâÈÅ∏Êäû
            const selectCardAction = async () => {
                if (!selectedCard) return;
                
                const newPlayers = gameState.players.map(p => {
                    if (p.id === myId) {
                        return { 
                            ...p, 
                            selected: selectedCard, 
                            hand: p.hand.filter(c => c !== selectedCard) 
                        };
                    }
                    return p;
                });

                // ÂÖ®Âì°ÈÅ∏Êäû„Åó„Åü„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                const allSelected = newPlayers.every(p => p.selected !== null);
                
                let updates = { players: newPlayers };
                
                if (allSelected) {
                    updates.phase = "resolution";
                    // „Åì„Åì„ÅßËß£Ê±∫Âá¶ÁêÜ„ÇíÂëº„Å≥Âá∫„Åô„ÅÆ„ÅØ„Éõ„Çπ„Éà„ÅÆÂΩπÂâ≤„Å´„Åô„Çã„Åå„ÄÅ
                    // Á∞°Âçò„ÅÆ„Åü„ÇÅ„ÄÅstatus„Çíresolution„Å´„Åó„Å¶„ÄÅuseEffect„Åß„Éõ„Çπ„Éà„ÅåÂá¶ÁêÜ„Åô„Çã„Çà„ÅÜ„Å´„Åô„Çã
                }

                await db.collection("rooms").doc(roomId).update(updates);
                setSelectedCard(null);
            };

            // „Éõ„Çπ„Éà„Å´„Çà„Çã„Çø„Éº„É≥Ëß£Ê±∫Áõ£Ë¶ñ
            useEffect(() => {
                if (!gameState || gameState.hostId !== myId || gameState.phase !== "resolution") return;

                const resolveTurn = async () => {
                    // ÂÖ®Âì°„ÅÆÈÅ∏Êäû„Ç´„Éº„Éâ„ÇíÂèñÂæó„Åó„ÄÅÂÄ§„Åß„ÇΩ„Éº„Éà
                    let players = [...gameState.players];
                    let rows = [...gameState.rows];
                    
                    // ÈÅ∏Êäû„Ç´„Éº„Éâ„É™„Çπ„Éà„Çí‰ΩúÊàê: [{playerId, card}, ...]
                    const moves = players.map(p => ({ playerId: p.id, card: p.selected }))
                                         .sort((a, b) => a.card - b.card);

                    // 1Êûö„Åö„Å§Âá¶ÁêÜÔºàÈùûÂêåÊúü„ÅßStateÊõ¥Êñ∞„ÅåÂøÖË¶Å„Å™„Åü„ÇÅ„ÄÅË§áÈõë„Å™Âá¶ÁêÜ„Å´„Å™„ÇãÔºâ
                    // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´„ÄåÊúÄÂàù„ÅÆ1Êûö„Äç„ÇíÂá¶ÁêÜ„Åó„Å¶„ÄÅ„ÇÇ„ÅóË°åÈÅ∏Êäû„ÅåÂøÖË¶Å„Å™„ÇâÊ≠¢„ÇÅ„Çã„É≠„Ç∏„ÉÉ„ÇØ„Å´„Åô„Çã
                    
                    // „Åô„Åß„Å´Âá¶ÁêÜ‰∏≠„ÅÆ„Ç´„Éº„Éâ„Åå„ÅÇ„Çå„Å∞„Çπ„Ç≠„ÉÉ„Éó
                    if (gameState.pendingCard) return;

                    // Êú™Âá¶ÁêÜ„ÅÆ„Ç´„Éº„Éâ„ÇíÊé¢„ÅôÔºàplayersÈÖçÂàóÂÜÖ„ÅÆselected„ÅØ‰øùÊåÅ„Åï„Çå„Å¶„ÅÑ„ÇãÔºâ
                    // „Åì„Åì„ÅØÁ∞°ÊòìÂÆüË£Ö„ÅÆ„Åü„ÇÅ„ÄÅ„É°„É¢„É™‰∏ä„Åß‰∏ÄÊ∞ó„Å´Ë®àÁÆó„Åß„Åç„Çã„Å®„Åì„Çç„Åæ„ÅßË®àÁÆó„Åô„Çã
                    
                    // „Åó„Åã„Åó„ÄÅË°åÈÅ∏ÊäûÔºàÂ∞è„Åï„ÅÑÊï∞„ÇíÂá∫„Åó„ÅüÂ†¥ÂêàÔºâ„ÅØ„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ„ÅåÂøÖË¶Å„ÄÇ
                    // „Å™„ÅÆ„Åß„ÄÅ„É≠„Ç∏„ÉÉ„ÇØÔºö
                    // moves„ÅÆÂÖàÈ†≠„ÇíË¶ã„Çã„ÄÇ
                    // „Åù„ÅÆ„Ç´„Éº„Éâ„ÅåËá™ÂãïÈÖçÁΩÆÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ„ÄÇ
                    // ÂèØËÉΩ -> ÈÖçÁΩÆ„Åó„Å¶Êõ¥Êñ∞ -> ÂÜçÂ∫¶useEffect„ÅåËµ∞„Çã
                    // ‰∏çÂèØËÉΩÔºàË°åÈÅ∏ÊäûÔºâ -> phase„Çí'row_selection'„Å´„Åó„ÄÅË©≤ÂΩì„Éó„É¨„Ç§„É§„Éº„Å´ÂÖ•Âäõ„Çí‰øÉ„Åô
                    
                    // „Åæ„Å†Áõ§Èù¢„Å´ÁΩÆ„Åã„Çå„Å¶„ÅÑ„Å™„ÅÑÔºàÂá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÔºâ„Éó„É¨„Ç§„É§„Éº„ÅÆmove„ÇíÊé¢„Åô
                    // ‚Äª „Åì„Åì„Åß„ÅØ„Äåselected„Åånull„Åß„Å™„ÅÑ„Éó„É¨„Ç§„É§„Éº„Äç„ÇíÊú™Âá¶ÁêÜ„Å®„Åø„Å™„Åô
                    // ÔºàÂá¶ÁêÜÂÆå‰∫ÜÊôÇ„Å´selected„Çínull„Å´„Åó„ÄÅ„Ç´„Éº„Éâ„Çírows„Å´ËøΩÂä†„Åô„ÇãË®≠Ë®àÔºâ
                    
                    const activeMoves = players.filter(p => p.selected !== null)
                                               .map(p => ({ playerId: p.id, card: p.selected }))
                                               .sort((a, b) => a.card - b.card);

                    if (activeMoves.length === 0) {
                        // ÂÖ®Âì°Âá¶ÁêÜÂÆå‰∫Ü -> Ê¨°„ÅÆ„Çø„Éº„É≥„Å∏
                        if (gameState.turnCount >= 10) {
                            await db.collection("rooms").doc(roomId).update({ status: "game_end", phase: "finished" });
                        } else {
                            await db.collection("rooms").doc(roomId).update({ 
                                phase: "selection", 
                                turnCount: gameState.turnCount + 1 
                            });
                        }
                        return;
                    }

                    const currentMove = activeMoves[0];
                    const card = currentMove.card;
                    const playerId = currentMove.playerId;

                    // ÊúÄÈÅ©„Å™Ë°å„ÇíÊé¢„Åô
                    let targetRowIndex = -1;
                    let maxVal = -1;

                    rows.forEach((row, index) => {
                        const lastCard = row[row.length - 1];
                        if (card > lastCard && lastCard > maxVal) {
                            maxVal = lastCard;
                            targetRowIndex = index;
                        }
                    });

                    if (targetRowIndex !== -1) {
                        // Ëá™ÂãïÈÖçÁΩÆ
                        let newRows = [...rows];
                        let takenCows = 0;
                        let player = players.find(p => p.id === playerId);

                        if (newRows[targetRowIndex].length >= 5) {
                            // 6ÊûöÁõÆÔºÅÂàóÂõûÂèé
                            takenCows = newRows[targetRowIndex].reduce((acc, c) => acc + getCows(c), 0);
                            newRows[targetRowIndex] = [card]; // „Åù„ÅÆ„Ç´„Éº„Éâ„ÅåÊñ∞„Åó„ÅÑÂÖàÈ†≠
                        } else {
                            newRows[targetRowIndex].push(card);
                        }

                        // „Éó„É¨„Ç§„É§„ÉºÊõ¥Êñ∞
                        const updatedPlayers = players.map(p => {
                            if (p.id === playerId) {
                                return { ...p, score: p.score + takenCows, selected: null }; // selected null„ÅßÂá¶ÁêÜÊ∏à„Éï„É©„Ç∞
                            }
                            return p;
                        });

                        await db.collection("rooms").doc(roomId).update({
                            rows: newRows,
                            players: updatedPlayers
                        });
                    } else {
                        // ÁΩÆ„Åë„ÇãË°å„Åå„Å™„ÅÑ -> „É¶„Éº„Ç∂„Éº„Å´Ë°åÈÅ∏Êäû„Åï„Åõ„Çã
                        await db.collection("rooms").doc(roomId).update({
                            phase: "row_selection",
                            pendingCard: card,
                            pendingPlayerId: playerId
                        });
                    }
                };
                
                // Â∞ë„ÅóÈÅÖÂª∂„ÇíÂÖ•„Çå„Å¶„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÊÑü„Çí‰Ωú„Çã
                const timer = setTimeout(resolveTurn, 1000);
                return () => clearTimeout(timer);

            }, [gameState, myId, roomId]);


            // Ë°åÈÅ∏Êäû„Ç¢„ÇØ„Ç∑„Éß„É≥ÔºàÂ∞è„Åï„ÅÑ„Ç´„Éº„Éâ„ÇíÂá∫„Åó„ÅüÊôÇÔºâ
            const selectRowAction = async (rowIndex) => {
                if (gameState.phase !== "row_selection" || gameState.pendingPlayerId !== myId) return;

                const rows = [...gameState.rows];
                const card = gameState.pendingCard;
                
                // ÈÅ∏Êäû„Åó„ÅüË°å„ÇíÂõûÂèé
                const takenCows = rows[rowIndex].reduce((acc, c) => acc + getCows(c), 0);
                rows[rowIndex] = [card];

                const players = gameState.players.map(p => {
                    if (p.id === myId) {
                        return { ...p, score: p.score + takenCows, selected: null }; // Âá¶ÁêÜÂÆå‰∫Ü
                    }
                    return p;
                });

                await db.collection("rooms").doc(roomId).update({
                    rows: rows,
                    players: players,
                    phase: "resolution", // Ëß£Ê±∫„Éï„Çß„Éº„Ç∫„Å´Êàª„Çã
                    pendingCard: null,
                    pendingPlayerId: null
                });
            };
            
            // Êñ∞„Åó„ÅÑ„Ç≤„Éº„É†„Å∏
            const resetGame = async () => {
                 await db.collection("rooms").doc(roomId).update({
                    status: "waiting",
                    phase: "selection",
                    turnCount: 0,
                    players: gameState.players.map(p => ({...p, score: 0, hand: [], selected: null}))
                 });
            }


            // ====================
            // „É¨„É≥„ÉÄ„É™„É≥„Ç∞„É≠„Ç∏„ÉÉ„ÇØ
            // ====================

            if (view === "setup") {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-green-900">
                        <h1 className="text-4xl font-bold mb-8 text-yellow-400 drop-shadow-md">Cow Taker</h1>
                        
                        {!db && (
                            <div className="bg-red-500/80 p-4 rounded mb-4 max-w-md text-sm">
                                <b>Ë®≠ÂÆö„ÅåÂøÖË¶Å„Åß„Åô:</b> index.htmlÂÜÖ„ÅÆ `firebaseConfig` „Å´API„Ç≠„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                            </div>
                        )}
                        
                        <div className="bg-white/10 backdrop-blur-md p-6 rounded-xl w-full max-w-sm">
                            <input 
                                className="w-full p-3 mb-4 rounded text-slate-800 font-bold"
                                placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†"
                                value={playerName}
                                onChange={e => setPlayerName(e.target.value)}
                            />
                            <button onClick={createRoom} className="w-full bg-yellow-500 hover:bg-yellow-400 text-yellow-900 font-bold p-3 rounded mb-2 transition">
                                ÈÉ®Â±ã„Çí‰Ωú„Çã
                            </button>
                            <div className="flex gap-2">
                                <input 
                                    className="flex-1 p-3 rounded text-slate-800 uppercase"
                                    placeholder="ÈÉ®Â±ãID"
                                    value={roomId}
                                    onChange={e => setRoomId(e.target.value.toUpperCase())}
                                />
                                <button onClick={joinRoom} className="bg-sky-500 hover:bg-sky-400 px-6 rounded font-bold transition">
                                    ÂèÇÂä†
                                </button>
                            </div>
                            {error && <p className="text-red-300 mt-2 text-sm text-center">{error}</p>}
                        </div>
                    </div>
                );
            }

            if (view === "lobby" && gameState) {
                const isHost = gameState.hostId === myId;
                return (
                    <div className="min-h-screen p-6 bg-green-900 flex flex-col items-center">
                        <div className="text-center mb-8">
                            <p className="text-sm text-green-300">ROOM ID</p>
                            <h2 className="text-6xl font-bold tracking-widest">{roomId}</h2>
                        </div>
                        
                        <div className="w-full max-w-md bg-white/10 rounded-xl p-4 mb-8">
                            <h3 className="text-green-300 border-b border-green-700 pb-2 mb-2">ÂèÇÂä†ËÄÖ ({gameState.players.length})</h3>
                            {gameState.players.map(p => (
                                <div key={p.id} className="flex justify-between py-2 border-b border-green-800/50 last:border-0">
                                    <span>{p.name} {p.id === gameState.hostId && 'üëë'}</span>
                                    {gameState.status === "game_end" && <span>{p.score}üêÆ</span>}
                                </div>
                            ))}
                        </div>

                        {isHost && gameState.status === "waiting" && (
                            <button onClick={startGame} className="bg-yellow-500 text-yellow-900 text-xl font-bold px-12 py-4 rounded-full shadow-lg hover:scale-105 transition">
                                „Ç≤„Éº„É†ÈñãÂßã
                            </button>
                        )}
                        
                        {gameState.status === "playing" && (
                            <div className="text-2xl animate-pulse">„Ç≤„Éº„É†ÈÄ≤Ë°å‰∏≠...</div>
                        )}
                        
                        {gameState.status === "game_end" && isHost && (
                             <button onClick={resetGame} className="bg-sky-500 text-white font-bold px-8 py-3 rounded mt-4">
                                „ÇÇ„ÅÜ‰∏ÄÂ∫¶ÈÅä„Å∂
                            </button>
                        )}
                    </div>
                );
            }

            if (gameState && (gameState.status === "playing" || gameState.status === "game_end")) {
                const myPlayer = gameState.players.find(p => p.id === myId);
                const isMyTurnToSelectRow = gameState.phase === "row_selection" && gameState.pendingPlayerId === myId;
                
                if(gameState.status === "game_end") {
                     // Á∞°Êòì„É™„Ç∂„É´„Éà
                     const sortedPlayers = [...gameState.players].sort((a,b) => a.score - b.score);
                     return (
                         <div className="min-h-screen bg-green-900 flex flex-col items-center justify-center p-4">
                             <h2 className="text-4xl font-bold mb-6 text-yellow-400">ÁµêÊûúÁô∫Ë°®!</h2>
                             <div className="bg-white text-slate-800 rounded-lg p-6 w-full max-w-md shadow-xl">
                                 {sortedPlayers.map((p, i) => (
                                     <div key={p.id} className={`flex justify-between items-center p-3 border-b ${i===0 ? 'bg-yellow-100 font-bold text-lg' : ''}`}>
                                         <div className="flex items-center gap-2">
                                             <span className="w-6 text-center">{i+1}.</span>
                                             <span>{p.name}</span>
                                         </div>
                                         <span>{p.score} üêÆ</span>
                                     </div>
                                 ))}
                             </div>
                             {gameState.hostId === myId && (
                                 <button onClick={resetGame} className="mt-8 bg-sky-500 text-white font-bold px-8 py-3 rounded">
                                    „É≠„Éì„Éº„Å´Êàª„Çã
                                </button>
                             )}
                         </div>
                     )
                }

                return (
                    <div className="h-screen flex flex-col bg-green-800 overflow-hidden">
                        {/* „Éò„ÉÉ„ÉÄ„Éº: ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†± */}
                        <div className="flex-none p-2 bg-green-900 flex gap-2 overflow-x-auto no-scrollbar">
                            {gameState.players.filter(p => p.id !== myId).map(p => (
                                <div key={p.id} className={`flex flex-col items-center min-w-[60px] p-1 rounded ${p.selected ? 'bg-green-700' : ''}`}>
                                    <span className="text-xs truncate w-full text-center">{p.name}</span>
                                    <div className="flex items-center gap-1">
                                        <div className="w-4 h-6 bg-indigo-900 border border-white/50 rounded"></div>
                                        <span className="text-xs font-bold">{p.score}</span>
                                    </div>
                                    {/* Ëß£Ê±∫„Éï„Çß„Éº„Ç∫„Åß„Ç´„Éº„Éâ„ÇíË°®Á§∫ */}
                                    {gameState.phase !== "selection" && p.selected !== null && (
                                        <div className="absolute top-10 z-10 scale-75 shadow-lg">
                                            <Card num={p.selected} size="sm" />
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {/* „É°„Ç§„É≥„Éú„Éº„Éâ: 4„Å§„ÅÆÂàó */}
                        <div className="flex-1 p-4 overflow-y-auto bg-[#2D6E32] shadow-inner relative">
                             {/* ÈÄöÁü•„Ç®„É™„Ç¢ */}
                            {isMyTurnToSelectRow && (
                                <div className="absolute inset-0 z-20 bg-black/60 flex items-center justify-center pointer-events-none">
                                    <div className="bg-white text-slate-900 p-4 rounded-xl shadow-xl animate-bounce">
                                        <p className="font-bold">Âºï„ÅçÂèñ„ÇãÂàó„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑÔºÅ</p>
                                    </div>
                                </div>
                            )}

                            {gameState.rows.map((row, i) => (
                                <Row 
                                    key={i} 
                                    cards={row} 
                                    isSelectable={isMyTurnToSelectRow}
                                    onSelect={() => isMyTurnToSelectRow && selectRowAction(i)}
                                />
                            ))}
                        </div>

                        {/* Ëá™ÂàÜ„ÅÆÊÉÖÂ†± & „Éè„É≥„Éâ */}
                        <div className="flex-none bg-green-900 p-2 pb-6 rounded-t-xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)] z-10">
                            <div className="flex justify-between items-center px-2 mb-2">
                                <div>
                                    <span className="font-bold text-yellow-400">{myPlayer.name}</span>
                                    <span className="ml-2 text-sm text-white/70">Â§±ÁÇπ: {myPlayer.score}</span>
                                </div>
                                <div className="text-xs bg-black/30 px-2 py-1 rounded">
                                    Round {gameState.turnCount}/10
                                </div>
                            </div>
                            
                            {/* „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ */}
                            {gameState.phase === "selection" && myPlayer.selected === null && (
                                <div className="flex justify-center mb-2 h-10">
                                    {selectedCard ? (
                                        <button 
                                            onClick={selectCardAction}
                                            className="bg-yellow-500 hover:bg-yellow-400 text-yellow-900 font-bold px-8 py-1 rounded-full shadow-lg transition transform active:scale-95"
                                        >
                                            Ê±∫ÂÆö
                                        </button>
                                    ) : (
                                        <div className="text-sm text-white/50 py-1">„Ç´„Éº„Éâ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</div>
                                    )}
                                </div>
                            )}
                            
                            {myPlayer.selected !== null && gameState.phase === "selection" && (
                                <div className="text-center text-sm text-green-300 mb-2 h-10 flex items-center justify-center">
                                    ‰ªñ„ÅÆ„Éó„É¨„Ç§„É§„Éº„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...
                                </div>
                            )}

                            {/* ÊâãÊú≠ */}
                            <div className="flex gap-2 overflow-x-auto px-2 pb-2 no-scrollbar min-h-[5rem]">
                                {myPlayer.hand.map(num => (
                                    <div key={num} className="flex-none">
                                        <Card 
                                            num={num} 
                                            selected={selectedCard === num} 
                                            onClick={(n) => gameState.phase === "selection" && myPlayer.selected === null ? setSelectedCard(n) : null}
                                        />
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            return null;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

